from app.ai.gemini_client import generate_with_gemini
from app.schemas.report_schema import ReportInput

def create_report(report_data: ReportInput) -> dict:
    
    # איסוף כל המידע מהמפגשים ומההערות לטקסט אחד
    raw_input_data = ""
    for session in report_data.sessions:
        raw_input_data += f"תאריך: {session.date}\nהערות ומידע קליני: {session.notes}\nתרגילים שבוצעו: {', '.join(session.exercises_done)}\n\n"

    # --- הפרומפט המשודרג ---
    prompt = f"""
    אתה קלינאי תקשורת מומחה בישראל. עליך לכתוב "דוח בקשה להמשך טיפול" מקצועי ורשמי עבור קופת חולים.
    
    עליך לבסס את הדוח על הנתונים הגולמיים הבאים:
    שם המטופל: {report_data.patient_name}
    מידע קליני מהמטפל:
    {raw_input_data}

    --- הנחיות כתיבה קפדניות ---
    1. **מבנה הדוח:** עליך להשתמש במבנה הבא בדיוק:
       - **רקע כללי וסיבת הפניה:** (גיל, שפות בבית, תלונות הורים/גננת).
       - **תפקוד נוכחי:** (חוזקות המטופל, התנהגות בטיפול, הבנה מול הבעה).
       - **מהלך הטיפול:** (מה תורגל, התקדמות שנעשתה, קשיים שעדיין בולטים - השתמש במונחים כמו: מורפולוגיה, תחביר, שליפה, היגוי).
       - **בקשה להמשך טיפול:** (הסבר משכנע מדוע יש צורך בעוד טיפולים).
       - **מטרות טיפוליות להמשך:** (רשימה ממוספרת של 3-5 מטרות ברורות ומדידות).

    2. **סגנון שפה:**
       - כתוב בגוף שלישי ("המטופל", "זאבי").
       - השתמש בשפה קלינית גבוהה (למשל: במקום "הוא לא אומר טוב מילים", כתוב "קיימים קשיים במובנות הדיבור ובהיגוי").
       - היה אובייקטיבי ומקצועי.

    3. **עיבוד המידע:**
       - קח את ההערות המבולגנות והפוך אותן לפסקאות מסודרות.
       - אם חסר מידע ספציפי (כמו תעודת זהות), אל תמציא, פשוט השמט את השדה הזה.
       - המטרה היא לשכנע את הגורם המבטח לאשר המשך טיפול.

    כתוב את הדוח המלא כעת בעברית:
    """
    
    # שליחה ל-AI
    ai_response = generate_with_gemini(prompt)
    
    return {"report_text": ai_response}