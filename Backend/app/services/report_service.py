# from app.ai.gemini_client import generate_with_gemini

# def create_report(patient_name, sessions):
#     # איסוף ההערות מהטיפולים
#     all_notes = " ".join([s.get('notes', '') for s in sessions])
    
#     # הפרומפט המקצועי עם המבנה המדויק שביקשת
#     prompt = f"""
#     אתה קלינאי תקשורת מומחה. עליך לכתוב דוח סיכום טיפול ובקשה להמשך טיפול מקצועי בעברית.
    
#     נתוני המטופל:
#     שם: {patient_name}
#     הערות קליניות: {all_notes}
    
#     עליך לכתוב את הדוח בדיוק במבנה הבא:

#     בס"ד
#     בקשת המשך טיפול שפה ודיבור
#     תאריך: [תאריך של היום]
#     שם מטופל: {patient_name}
#     ת.ז.: [השאר ריק למילוי]
#     תאריך לידה: [השאר ריק למילוי]
#     גיל: [הסק מההערות או השאר ריק]
#     מסגרת חינוכית: גן 
#     מספר טיפולים שנעשו: [השאר ריק]
    
#     רקע כללי:
#     [תאר את הרקע המשפחתי והשפתי על בסיס ההערות]

#     סיבת הפנייה:
#     [פרט את קשיי השפה והדיבור]

#     סיכום אבחון שפה:
#     [סכם את הממצאים העיקריים]

#     תפקוד נוכחי לפי דיווח ההורים והמטפל:
#     [תיאור היכולות כיום]

#     מטרות טיפוליות:
#     [פרט 4-5 מטרות שעבדתם עליהן]

#     מהלך הטיפול:
#     [תאר את שיתוף הפעולה, המוטיבציה וההתקדמות]

#     בקשה להמשך טיפול:
#     [הסבר מדוע נדרשים עוד 12 טיפולים ומהם המוקדים העיקריים להמשך]
    
#     המלצות להמשך:
#     המשך מעקב א.א.ג.

#     בכבוד רב,
#     [שם המטפל/ת]
#     קלינאי/ת תקשורת
#     """
    
#     return generate_with_gemini(prompt)

from app.ai.gemini_client import generate_with_gemini
from datetime import datetime

def create_report(patient_name, sessions):
    # איסוף ההערות מהטיפולים - מוזח פנימה
    all_notes = " ".join([s.get('notes', '') for s in sessions])
    current_date = datetime.now().strftime("%d.%m.%Y")
    
    # הפרומפט המקצועי המשודרג - חייב להתחיל באותה רמת הזחה!
    prompt = f"""אתה קלינאי תקשורת מומחה בכיר. עליך להפוך את ההערות הגולמיות לדוח "בקשת המשך טיפול" רשמי ומקצועי.

נתוני המטופל:
שם: {patient_name}
הערות גולמיות: {all_notes}

הנחיות קריטיות למבנה המסמך (חובה):
1. פתח ב- "## בס"ד" ממורכז.
2. מתחתיו כותרת: "## בקשת המשך טיפול שפה ודיבור".
3. פרטים אישיים בשורות צמודות (ללא רווחים ביניהן):
   **תאריך:** {current_date}
   **שם מטופל:** {patient_name}
   **ת.ז.:** [השאר ריק]
   **תאריך לידה:** [השאר ריק]
   **גיל:** [הסק מההערות]
   **מסגרת חינוכית:** [הסק מההערות]
   **מספר טיפולים שנעשו:** [הסק מההערות]

4. תוכן הדוח (השתמש ב-### לכל כותרת):
   ### רקע כללי: (כולל הרקע השפתי והרפואי)
   ### סיבת הפנייה: (תיאור הקשיים המקוריים)
   ### סיכום אבחון שפה: (ממצאים קליניים וסטיות תקן אם הוזכרו)
   ### תפקוד נוכחי לפי דיווח ההורים והמטפל: (היכולות כיום)
   ### מידת היענות ההורים: (נוכחות והדרכה)
   ### מטרות טיפוליות: (רשימה ממוספרת 1-5 של מטרות ספציפיות)
   ### מהלך הטיפול: (תיאור התקדמות מול קשיים שנותרו, השתמש בדוגמאות מילוליות מההערות)
   ### בקשה להמשך טיפול: (פסקה משכנעת המבקשת 12/24 טיפולים נוספים ומוקדי עבודה)
   ### המלצות להמשך: (מעקב א.א.ג וכו')

דגשים:
- שפה קלינית גבוהה: מורפולוגיה, תחביר, מובנות דיבור, ארגון מסר, הכללה.
- אל תשתמש בכוכביות מיותרות בתוך הפסקאות, רק עבור הכותרות והפרטים האישיים.
- שמור על הטון המקצועי והרשמי של קלינאית תקשורת.
"""
    return generate_with_gemini(prompt)